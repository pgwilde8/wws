{% extends "layout/base.html" %}
{% block title %}Onboarding – WebWise Solutions{% endblock %}
{% block header %}{% endblock %}
{% block footer %}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 sm:p-6 space-y-6">

  <!-- Header -->
  <header class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
    <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900">Activate Your System</h1>
    <p class="text-xs sm:text-sm text-gray-600 mt-1">
      One quick intake form so we can wire your business machine correctly.
    </p>

    {% include "partials/onboarding_email_privacy.html" %}
  </header>
  <!-- Tutorial Videos (overview only; section-specific buttons below) -->
  <section class="bg-white border p-5 rounded-2xl shadow-sm space-y-3">
    <div class="flex items-center justify-between gap-3">
      <div>
        <h2 class="text-lg font-bold text-gray-900">How this page works</h2>
        <p class="text-sm text-gray-600">Watch a quick overview, then see section-specific tutorials below.</p>
      </div>
      <button type="button" class="px-3 py-2 text-xs font-semibold bg-gray-900 text-white rounded-full hover:opacity-90" data-video="/static/videos/vtest1.mp4"">
        Watch overview
      </button>
    </div>
  </section>
  <!-- Form -->
  <section class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
    <form id="onboarding-form" class="space-y-6" method="post" action="/client/onboarding">
       
      <!-- 1) Identity -->
      <div>
        <h2 class="text-lg font-bold text-gray-900">1) Business Profile</h2>
        <p class="text-sm text-gray-600">Tell us what you’re building so we can wire the system correctly.</p>

        <div class="grid sm:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Full name *</label>
            <input name="full_name" required class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="Jane Smith">
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Business / brand name *</label>
            <input name="business_name" required class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="Suzie’s Nails">
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Industry *</label>
            <input name="industry" required class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="Salon, HVAC, Coaching, Real Estate…">
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Phone (optional)</label>
            <input name="phone" class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="+1 (555) 123-4567">
          </div>
        </div>

        <!-- Prompt Generator -->
        <div class="mt-6 space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-bold text-gray-900">Prompt Generator (optional)</h3>
            <span class="text-xs text-gray-500">Build a great system prompt for your ai agent on your site</span>
            <button type="button" class="px-3 py-1 text-xs font-semibold bg-gray-900 text-white rounded-full hover:opacity-90" data-video="https://www.youtube.com/embed/dQw4w9WgXcQ">
              Watch how it works
            </button>
          </div>
          <p class="text-xs text-gray-600">
            The Site description box below becomes your website AI agent’s system prompt. Use the guided questions and/or paste rough notes, then click “Generate System Prompt.” We’ll place the generated prompt into Site description so the agent knows your services, tone, policies, and how to handle leads.
          </p>

          <!-- Guided builder -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-3">
            <p class="text-xs font-semibold text-gray-700">Guided builder</p>
            <div class="grid sm:grid-cols-2 gap-3 text-sm">
              <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">Services</label>
                <input id="guided-services" class="w-full border rounded-lg p-2 bg-white" placeholder="Haircuts, HVAC install, coaching...">
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">Offers</label>
                <input id="guided-offers" class="w-full border rounded-lg p-2 bg-white" placeholder="Free consult, $99 tune-up...">
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">Tone</label>
                <input id="guided-tone" class="w-full border rounded-lg p-2 bg-white" placeholder="Friendly, premium, bold...">
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">Policies</label>
                <input id="guided-policies" class="w-full border rounded-lg p-2 bg-white" placeholder="Refunds, timelines, guarantees...">
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">FAQs</label>
                <input id="guided-faqs" class="w-full border rounded-lg p-2 bg-white" placeholder="Common questions we answer...">
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">Booking / lead flow</label>
                <input id="guided-booking" class="w-full border rounded-lg p-2 bg-white" placeholder="Collect name/email/phone, book consult...">
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">Differentiators</label>
                <input id="guided-diff" class="w-full border rounded-lg p-2 bg-white" placeholder="Family-owned, 24/7 support...">
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">Locations / audience</label>
                <input id="guided-locations" class="w-full border rounded-lg p-2 bg-white" placeholder="Service Area">
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1">Who needs your service?</label>
                <input id="guided-who" class="w-full border rounded-lg p-2 bg-white" placeholder="Homeowners, SMB owners, busy parents...">
              </div>
            </div>
          </div>

          <!-- Raw notes -->
          <p class="text-xs text-gray-600">Or paste rough notes below.</p>
          <textarea id="prompt-gen-input" rows="4" class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="Services, offers, tone, policies, FAQs, booking/lead flow, what to emphasize..."></textarea>
          <div class="flex gap-3 items-center">
            <button id="prompt-gen-btn" type="button" class="px-4 py-2 bg-gray-900 text-white text-sm font-bold rounded-full hover:opacity-90 transition">
              Generate System Prompt
            </button>
            <span id="prompt-gen-status" class="text-xs text-gray-600"></span>
          </div>
        </div>

        <div class="mt-6 space-y-2">
          <label class="block text-xs font-semibold text-gray-600 mb-1">Site description *</label>
          <textarea name="site_description" required rows="4"
            class="w-full border rounded-lg p-2 text-sm bg-gray-50"
            placeholder="Very important! Answer questions or add notes above as detailed as possible, This will be the rule book for your websites AI-AGENT"></textarea>
        </div>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-1">Target audience (optional)</label>
          <input name="target_audience" class="w-full border rounded-lg p-2 text-sm bg-gray-50"
                 placeholder="Local customers, busy professionals, homeowners in NJ, etc.">
        </div>
      </div>

      <hr class="border-gray-200">

      <!-- 2) Brand -->
      <div>
        <h2 class="text-lg font-bold text-gray-900">2) Brand Preferences</h2>
        <p class="text-sm text-gray-600">Optional — if you’re not sure, we’ll choose clean defaults.</p>

        <div class="grid sm:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-2">Do you have a logo?</label>
            <div class="flex gap-3">
              <label class="inline-flex items-center text-sm">
                <input type="radio" name="has_logo" value="true" class="mr-2"> Yes
              </label>
              <label class="inline-flex items-center text-sm">
                <input type="radio" name="has_logo" value="false" class="mr-2" checked> No
              </label>
            </div>
            <p class="text-xs text-gray-500 mt-2">If no, we can generate one later.</p>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-2">Do you have favorite colors?</label>
            <div class="flex gap-3">
              <label class="inline-flex items-center text-sm">
                <input type="radio" name="has_colors" value="yes" class="mr-2"> Yes
              </label>
              <label class="inline-flex items-center text-sm">
                <input type="radio" name="has_colors" value="no" class="mr-2" checked> No
              </label>
            </div>
            <div id="colors-wrap" class="mt-3 hidden">
              <label class="block text-xs font-semibold text-gray-600 mb-1">List your colors</label>
              <input name="brand_colors" class="w-full border rounded-lg p-2 text-sm bg-gray-50"
                     placeholder="Example: black/white, gold accents, pastel pink…">
            </div>
          </div>
        </div>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-1">Site tone (optional)</label>
          <select name="site_tone" class="w-full border rounded-lg p-2 text-sm bg-gray-50">
            <option value="modern" selected>Modern / Clean</option>
            <option value="bold">Bold / High energy</option>
            <option value="luxury">Luxury / Premium</option>
            <option value="cozy">Warm / Cozy</option>
            <option value="minimal">Minimal</option>
          </select>
        </div>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-2">Upload logo (optional)</label>
          <input type="file" id="logo-file" accept="image/*" class="w-full text-sm">
          <p class="text-xs text-gray-500 mt-1">PNG/JPG; we’ll store a URL only.</p>
          <div id="logo-status" class="text-xs text-gray-600 mt-1"></div>
        </div>
      </div>

      <hr class="border-gray-200">

      <!-- 3) AI -->
      <div>
        <h2 class="text-lg font-bold text-gray-900">3) AI Assistant</h2>
        <p class="text-sm text-gray-600">If enabled, we create your assistant using the OpenAI key you provide.</p>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-2">Enable AI chat?</label>
          <div class="flex gap-3">
            <label class="inline-flex items-center text-sm">
              <input type="radio" name="wants_ai_chat" value="true" class="mr-2" checked> Yes
            </label>
            <label class="inline-flex items-center text-sm">
              <input type="radio" name="wants_ai_chat" value="false" class="mr-2"> No
            </label>
          </div>
        </div>

        <div id="openai-wrap" class="mt-4">
          <div class="flex items-center justify-between gap-3">
            <label class="block text-xs font-semibold text-gray-600 mb-1">OpenAI API key *</label>
            <div class="flex gap-2">
              <a href="https://platform.openai.com/signup" target="_blank"
                 class="px-3 py-2 bg-gray-900 text-white text-xs font-bold rounded-full hover:opacity-90 transition">
                Create OpenAI Account
              </a>
              <button type="button" class="px-3 py-2 bg-gray-700 text-white text-xs font-bold rounded-full hover:opacity-90 transition" data-video="https://www.youtube.com/embed/dQw4w9WgXcQ">
                Watch tutorial
              </button>
            </div>
          </div>
          <input type="password" name="openai_api_key"
                 class="w-full border rounded-lg p-2 text-sm bg-gray-50"
                 placeholder="••••••">
          <p class="text-xs text-gray-500 mt-2">
            We store keys securely. We never show your key back to you after saving.
          </p>
        </div>
      </div>

      <hr class="border-gray-200">

      <!-- 4) Calling -->
      <div>
        <h2 class="text-lg font-bold text-gray-900">4) Calling (Optional)</h2>
        <div class="flex flex-wrap items-center gap-3">
          <p class="text-sm text-gray-600">Enable inbound/outbound calling and SMS only if you want it.</p>
          <a href="https://www.twilio.com/try-twilio" target="_blank"
             class="px-3 py-2 bg-purple-600 text-white text-xs font-bold rounded-full hover:opacity-90 transition">
            Create a Twilio Account
          </a>
          <button type="button" class="px-3 py-2 bg-gray-700 text-white text-xs font-bold rounded-full hover:opacity-90 transition" data-video="https://www.youtube.com/embed/dQw4w9WgXcQ">
            Watch tutorial
          </button>
        </div>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-1">Calling direction</label>
          <select name="calling_direction" id="calling-direction" class="w-full border rounded-lg p-2 text-sm bg-gray-50">
            <option value="none" selected>No calling</option>
            <option value="inbound">Inbound only</option>
            <option value="outbound">Outbound only</option>
            <option value="both">Inbound + Outbound</option>
          </select>
        </div>

        <div id="twilio-wrap" class="mt-4 hidden space-y-3">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-sm font-semibold text-gray-900">Twilio credentials</p>
              <p class="text-xs text-gray-500">Only required if you enable calling.</p>
            </div>
            <div class="flex gap-2">
              <a href="https://www.twilio.com/try-twilio" target="_blank"
                 class="px-3 py-2 bg-purple-600 text-white text-xs font-bold rounded-full hover:opacity-90 transition">
                Create Twilio Account
              </a>
              <button type="button" class="px-3 py-2 bg-gray-700 text-white text-xs font-bold rounded-full hover:opacity-90 transition" data-video="https://www.youtube.com/embed/dQw4w9WgXcQ">
                Watch tutorial
              </button>
            </div>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Account SID</label>
            <input name="twilio_sid" class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="ACxxxxxxxx">
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Auth Token</label>
            <input type="password" name="twilio_token" class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="••••••">
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">From number (E.164)</label>
            <input name="twilio_from_number" class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="+17325079772">
          </div>

          <div class="pt-2">
            <label class="inline-flex items-center text-sm">
              <input type="checkbox" name="wants_sms" value="true" class="mr-2"> Enable SMS reminders
            </label>
          </div>

          <p class="text-xs text-gray-500">
            We store keys securely. We never show your Twilio token back to you after saving.
          </p>
        </div>
      </div>

      <hr class="border-gray-200">

      <!-- 5) Domain & DNS -->
      <div>
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-lg font-bold text-gray-900">5) Domain & DNS</h2>
            <p class="text-sm text-gray-600">
              Submit your domain so we can configure DNS automatically.
            </p>
          </div>
          <button type="button" class="px-3 py-2 bg-gray-700 text-white text-xs font-bold rounded-full hover:opacity-90 transition" data-video="https://www.youtube.com/embed/dQw4w9WgXcQ">
            Watch tutorial
          </button>
        </div>

        <div class="grid sm:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Domain name *</label>
            <input name="domain_name" required class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="example.com">
          </div>
        </div>

        <div class="grid sm:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-2">Do you already use Cloudflare?</label>
            <div class="flex gap-3">
              <label class="inline-flex items-center text-sm">
                <input type="radio" name="uses_cloudflare" value="true" class="mr-2"> Yes
              </label>
              <label class="inline-flex items-center text-sm">
                <input type="radio" name="uses_cloudflare" value="false" class="mr-2" checked> No
              </label>
            </div>
            <div id="cloudflare-email-wrap" class="mt-3 hidden">
              <label class="block text-xs font-semibold text-gray-600 mb-1">Cloudflare email (optional)</label>
              <input type="email" name="cloudflare_email" class="w-full border rounded-lg p-2 text-sm bg-gray-50"
                     placeholder="cloudflare-account@email.com">
            </div>
          </div>
        </div>
      </div>

      <hr class="border-gray-200">

      <!-- 6) Payments -->
      <div>
        <h2 class="text-lg font-bold text-gray-900">6) Payments (Optional)</h2>
        <p class="text-sm text-gray-600">Enable Stripe only if you need payments or paid bookings.</p>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-2">Do you want Stripe payments?</label>
          <div class="flex gap-3">
            <label class="inline-flex items-center text-sm">
              <input type="radio" name="wants_payments" value="true" class="mr-2" checked> Yes
            </label>
            <label class="inline-flex items-center text-sm">
              <input type="radio" name="wants_payments" value="false" class="mr-2"> No
            </label>
          </div>
        </div>

        <div id="stripe-wrap" class="mt-4 space-y-3">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-sm font-semibold text-gray-900">Stripe keys</p>
              <p class="text-xs text-gray-500">Only required if payments are enabled.</p>
            </div>
            <a href="https://dashboard.stripe.com/register" target="_blank"
               class="px-3 py-2 bg-purple-700 text-white text-xs font-bold rounded-full hover:opacity-90 transition">
              Create Stripe Account
            </a>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Publishable key (pk_)</label>
            <input name="stripe_publishable_key" class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="pk_live_...">
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Secret key (sk_)</label>
            <input type="password" name="stripe_secret_key" class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="••••••">
          </div>

          <p class="text-xs text-gray-500">
            We store keys securely. We never show your Stripe secret key back to you after saving.
          </p>
        </div>
      </div>

      <hr class="border-gray-200">

      <!-- 7) Email Forwarding -->
      <div>
        <h2 class="text-lg font-bold text-gray-900">7) Email Forwarding</h2>
        <p class="text-sm text-gray-600">
          Tell us where to forward leads captured from the site and the assistant.
        </p>
        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-1">Lead forwarding email *</label>
          <input type="email" name="lead_forward_email" required class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="you@yourbusiness.com">
          <p class="text-xs text-gray-500 mt-2">
            We forward leads here. We do not access or manage your inbox.
          </p>
        </div>
      </div>

      <hr class="border-gray-200">

      <!-- Submit -->
      <div class="pt-2">
        <label class="flex items-start gap-2 text-sm">
          <input type="checkbox" id="confirm-check" class="mt-1" required>
          <span>
            I confirm the information above is correct. I understand this intake form is submitted once.
          </span>
        </label>

        <button id="submit-btn" type="submit"
          class="mt-4 w-full px-6 py-3 bg-blue-600 text-white text-sm font-extrabold rounded-xl hover:opacity-90 transition">
          Submit Onboarding →
        </button>

        <p id="form-status" class="text-sm mt-3 text-gray-600"></p>
      </div>

    </form>
  </section>

</div>

<script>
(function () {
  const colorsYes = document.querySelector('input[name="has_colors"][value="yes"]');
  const colorsNo  = document.querySelector('input[name="has_colors"][value="no"]');
  const colorsWrap = document.getElementById('colors-wrap');

  const aiYes = document.querySelector('input[name="wants_ai_chat"][value="true"]');
  const aiNo  = document.querySelector('input[name="wants_ai_chat"][value="false"]');
  const openaiWrap = document.getElementById('openai-wrap');
  const openaiKeyInput = document.querySelector('input[name="openai_api_key"]');

  const callingSelect = document.getElementById('calling-direction');
  const twilioWrap = document.getElementById('twilio-wrap');

  const cfYes = document.querySelector('input[name="uses_cloudflare"][value="true"]');
  const cfNo  = document.querySelector('input[name="uses_cloudflare"][value="false"]');
  const cfEmailWrap = document.getElementById('cloudflare-email-wrap');

  const payYes = document.querySelector('input[name="wants_payments"][value="true"]');
  const payNo  = document.querySelector('input[name="wants_payments"][value="false"]');
  const stripeWrap = document.getElementById('stripe-wrap');

  function toggle(el, show) {
    if (!el) return;
    el.classList.toggle('hidden', !show);
  }

  function syncColors() {
    toggle(colorsWrap, !!(colorsYes && colorsYes.checked));
  }

  function syncAI() {
    const enabled = !!(aiYes && aiYes.checked);
    toggle(openaiWrap, enabled);
    // If AI is disabled, clear and remove required-ness
    if (!enabled && openaiKeyInput) openaiKeyInput.value = '';
  }

  function syncCalling() {
    const val = callingSelect ? callingSelect.value : 'none';
    toggle(twilioWrap, val !== 'none');
    // If calling disabled, clear fields
    if (val === 'none') {
      ['twilio_sid','twilio_token','twilio_from_number'].forEach(n => {
        const input = document.querySelector(`[name="${n}"]`);
        if (input) input.value = '';
      });
      const sms = document.querySelector('input[name="wants_sms"]');
      if (sms) sms.checked = false;
    }
  }

  function syncCloudflare() {
    toggle(cfEmailWrap, !!(cfYes && cfYes.checked));
    if (cfNo && cfNo.checked) {
      const input = document.querySelector('input[name="cloudflare_email"]');
      if (input) input.value = '';
    }
  }

  function syncPayments() {
    const enabled = !!(payYes && payYes.checked);
    toggle(stripeWrap, enabled);
    if (!enabled) {
      ['stripe_publishable_key','stripe_secret_key'].forEach(n => {
        const input = document.querySelector(`[name="${n}"]`);
        if (input) input.value = '';
      });
    }
  }

  // Wire events
  if (colorsYes) colorsYes.addEventListener('change', syncColors);
  if (colorsNo) colorsNo.addEventListener('change', syncColors);

  if (aiYes) aiYes.addEventListener('change', syncAI);
  if (aiNo) aiNo.addEventListener('change', syncAI);

  if (callingSelect) callingSelect.addEventListener('change', syncCalling);

  if (cfYes) cfYes.addEventListener('change', syncCloudflare);
  if (cfNo) cfNo.addEventListener('change', syncCloudflare);

  if (payYes) payYes.addEventListener('change', syncPayments);
  if (payNo) payNo.addEventListener('change', syncPayments);

  // Initial state
  syncColors();
  syncAI();
  syncCalling();
  syncCloudflare();
  syncPayments();
})();

// Handle single-submit onboarding
(function () {
  const form = document.getElementById('onboarding-form');
  const statusEl = document.getElementById('form-status');
  const logoInput = document.getElementById('logo-file');
  const logoStatus = document.getElementById('logo-status');
  const promptInput = document.getElementById('prompt-gen-input');
  const promptBtn = document.getElementById('prompt-gen-btn');
  const promptStatus = document.getElementById('prompt-gen-status');
  const siteDescriptionInput = document.querySelector('textarea[name="site_description"]');
  const domainInput = document.querySelector('input[name="domain_name"]');
  const cloudflareEmailInput = document.querySelector('input[name="cloudflare_email"]');
  const nameserversUpdatedInput = document.querySelector('input[name="nameservers_updated"]');
  let uploadedLogoUrl = null;

  function getRadioBool(name) {
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? el.value === 'true' : false;
  }

  if (form) {
    if (logoInput) {
      logoInput.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        logoStatus.textContent = 'Uploading logo...';
        const formData = new FormData();
        formData.append('file', file);
        formData.append('path', `logos/${file.name}`);
        try {
          const resp = await fetch('/upload-file', { method: 'POST', body: formData });
          if (!resp.ok) throw new Error('Upload failed');
          const data = await resp.json().catch(() => ({}));
          if (data?.url_path) {
            uploadedLogoUrl = data.url_path;
            logoStatus.textContent = 'Logo uploaded.';
          } else {
            throw new Error('No URL returned');
          }
        } catch (err) {
          uploadedLogoUrl = null;
          logoStatus.textContent = 'Logo upload failed.';
          console.error(err);
        }
      });
    }

    async function submitDomainIfPresent() {
      const domainVal = domainInput?.value?.trim();
      if (!domainVal) return;
      try {
        const resp = await fetch('/api/domain', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            domain_name: domainVal,
            cloudflare_email: cloudflareEmailInput?.value || null,
            nameservers_updated: nameserversUpdatedInput?.checked || false,
          }),
        });
        if (!resp.ok) {
          const data = await resp.json().catch(() => ({}));
          throw new Error(data.detail || 'DNS setup failed');
        }
        const data = await resp.json();
        if (statusEl) {
          statusEl.textContent = `Onboarding saved. DNS submitted for ${domainVal} (status: ${data.status || 'pending'}). We'll start provisioning shortly.`;
        }
      } catch (err) {
        if (statusEl) {
          statusEl.textContent = `Onboarding saved, but DNS setup could not start: ${err.message || err}`;
          statusEl.classList.add('text-orange-600');
        }
        console.error(err);
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = 'Submitting...';
      statusEl.classList.remove('text-red-600');
      statusEl.classList.remove('text-orange-600');

      const payload = {
        full_name: form.full_name.value,
        business_name: form.business_name.value,
        industry: form.industry.value,
        site_description: form.site_description.value,
        target_audience: form.target_audience.value || null,
        phone: form.phone.value || null,
        domain_name: form.domain_name.value,
        lead_forward_email: form.lead_forward_email.value,
        calling_direction: form['calling_direction'].value,
        wants_sms: form['wants_sms']?.checked || false,
        wants_payments: getRadioBool('wants_payments'),
        uses_cloudflare: getRadioBool('uses_cloudflare'),
        cloudflare_email: form.cloudflare_email?.value || null,
        twilio_sid: form.twilio_sid?.value || null,
        twilio_token: form.twilio_token?.value || null,
        twilio_from_number: form.twilio_from_number?.value || null,
        stripe_publishable_key: form.stripe_publishable_key?.value || null,
        stripe_secret_key: form.stripe_secret_key?.value || null,
        openai_api_key: form.openai_api_key?.value || null,
        has_logo: getRadioBool('has_logo'),
        brand_colors: form.brand_colors?.value || null,
        logo_url: uploadedLogoUrl,
      };

      try {
        const resp = await fetch('/dashboard/onboarding', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          const data = await resp.json().catch(() => ({}));
          throw new Error(data.detail || 'Submission failed');
        }
        statusEl.textContent = 'Onboarding saved. We\'ll start provisioning shortly.';
        // Kick off domain/DNS automation (best effort)
        await submitDomainIfPresent();
      } catch (err) {
        statusEl.textContent = err.message || 'Unable to submit onboarding.';
        statusEl.classList.add('text-red-600');
      }
    });
  }

  // Prompt generator
  async function runGenerator(raw) {
    if (!raw) {
      if (promptStatus) promptStatus.textContent = 'Add some notes first.';
      return;
    }
    if (promptStatus) promptStatus.textContent = 'Generating...';
    try {
      const resp = await fetch('/dashboard/onboarding/generate-prompt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ raw_text: raw }),
      });
      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        throw new Error(data.detail || 'Failed to generate.');
      }
      const data = await resp.json();
      if (siteDescriptionInput && data.prompt) {
        siteDescriptionInput.value = data.prompt;
        siteDescriptionInput.focus();
      }
      if (promptStatus) promptStatus.textContent = 'Done. Added into Site description.';
    } catch (err) {
      if (promptStatus) promptStatus.textContent = err.message || 'Unable to generate prompt.';
      console.error(err);
    }
  }

  if (promptBtn) {
    promptBtn.addEventListener('click', () => {
      const fields = [
        ['Services', document.getElementById('guided-services')?.value],
        ['Offers', document.getElementById('guided-offers')?.value],
        ['Tone', document.getElementById('guided-tone')?.value],
        ['Policies', document.getElementById('guided-policies')?.value],
        ['FAQs', document.getElementById('guided-faqs')?.value],
        ['Booking / lead flow', document.getElementById('guided-booking')?.value],
        ['Differentiators', document.getElementById('guided-diff')?.value],
        ['Locations / audience', document.getElementById('guided-locations')?.value],
      ].filter(([, v]) => v && v.trim());

      const guidedText = fields.map(([label, value]) => `${label}: ${value.trim()}`).join('\n');
      const rawNotes = promptInput?.value?.trim();
      const combined = [guidedText, rawNotes ? `Notes: ${rawNotes}` : ''].filter(Boolean).join('\n');
      runGenerator(combined);
    });
  }
})();
</script>
<script>
  // Simple modal for tutorial videos
  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.createElement('div');
    modal.id = 'tutorialModal';
    modal.style.position = 'fixed';
    modal.style.inset = '0';
    modal.style.background = 'rgba(0,0,0,0.65)';
    modal.style.display = 'none';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.style.zIndex = '9999';

    modal.innerHTML = `
      <div style="position: relative; width: min(900px, 92vw); aspect-ratio: 16 / 9; background: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.35);">
        <iframe id="tutorialFrame" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="width: 100%; height: 100%;"></iframe>
        <button id="tutorialClose" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 18px; cursor: pointer;">×</button>
      </div>
    `;
    document.body.appendChild(modal);

    const frame = document.getElementById('tutorialFrame');
    const closeBtn = document.getElementById('tutorialClose');

    function openModal(src) {
      frame.src = src;
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    function closeModal() {
      frame.src = '';
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }

    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
    closeBtn.addEventListener('click', closeModal);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    document.querySelectorAll('[data-video]').forEach(btn => {
      btn.addEventListener('click', () => {
        const src = btn.getAttribute('data-video');
        if (src) openModal(src);
      });
    });
  });
</script>
{% endblock %}
