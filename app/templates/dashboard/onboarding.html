{% extends "layout/base.html" %}
{% block title %}Onboarding – WebWise Solutions{% endblock %}
{% block header %}{% endblock %}
{% block footer %}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 sm:p-6 space-y-6">

  <!-- Header -->
  <header class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
    <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900">Activate Your System</h1>
    <p class="text-xs sm:text-sm text-gray-600 mt-1">
      One quick intake form so we can wire your business machine correctly.
    </p>

    {% include "partials/onboarding_email_privacy.html" %}
  </header>

  <!-- Form -->
  <section class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
    <form id="onboarding-form" class="space-y-6" method="post" action="/client/onboarding">

      <!-- 1) Identity -->
      <div>
        <h2 class="text-lg font-bold text-gray-900">1) Business Profile</h2>
        <p class="text-sm text-gray-600">Tell us what you’re building so we can wire the system correctly.</p>

        <div class="grid sm:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Full name *</label>
            <input name="full_name" required class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="Jane Smith">
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Business / brand name *</label>
            <input name="business_name" required class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="Suzie’s Nails">
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Industry *</label>
            <input name="industry" required class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="Salon, HVAC, Coaching, Real Estate…">
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Phone (optional)</label>
            <input name="phone" class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="+1 (555) 123-4567">
          </div>
        </div>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-1">Site description *</label>
          <textarea name="site_description" required rows="4"
            class="w-full border rounded-lg p-2 text-sm bg-gray-50"
            placeholder="What does your business do? What should the site and automation accomplish?"></textarea>
        </div>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-1">Target audience (optional)</label>
          <input name="target_audience" class="w-full border rounded-lg p-2 text-sm bg-gray-50"
                 placeholder="Local customers, busy professionals, homeowners in NJ, etc.">
        </div>
      </div>

      <hr class="border-gray-200">

      <!-- 2) Brand -->
      <div>
        <h2 class="text-lg font-bold text-gray-900">2) Brand Preferences</h2>
        <p class="text-sm text-gray-600">Optional — if you’re not sure, we’ll choose clean defaults.</p>

        <div class="grid sm:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-2">Do you have a logo?</label>
            <div class="flex gap-3">
              <label class="inline-flex items-center text-sm">
                <input type="radio" name="has_logo" value="true" class="mr-2"> Yes
              </label>
              <label class="inline-flex items-center text-sm">
                <input type="radio" name="has_logo" value="false" class="mr-2" checked> No
              </label>
            </div>
            <p class="text-xs text-gray-500 mt-2">If no, we can generate one later.</p>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-2">Do you have favorite colors?</label>
            <div class="flex gap-3">
              <label class="inline-flex items-center text-sm">
                <input type="radio" name="has_colors" value="yes" class="mr-2"> Yes
              </label>
              <label class="inline-flex items-center text-sm">
                <input type="radio" name="has_colors" value="no" class="mr-2" checked> No
              </label>
            </div>
            <div id="colors-wrap" class="mt-3 hidden">
              <label class="block text-xs font-semibold text-gray-600 mb-1">List your colors</label>
              <input name="brand_colors" class="w-full border rounded-lg p-2 text-sm bg-gray-50"
                     placeholder="Example: black/white, gold accents, pastel pink…">
            </div>
          </div>
        </div>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-1">Site tone (optional)</label>
          <select name="site_tone" class="w-full border rounded-lg p-2 text-sm bg-gray-50">
            <option value="modern" selected>Modern / Clean</option>
            <option value="bold">Bold / High energy</option>
            <option value="luxury">Luxury / Premium</option>
            <option value="cozy">Warm / Cozy</option>
            <option value="minimal">Minimal</option>
          </select>
        </div>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-2">Upload logo (optional)</label>
          <input type="file" id="logo-file" accept="image/*" class="w-full text-sm">
          <p class="text-xs text-gray-500 mt-1">PNG/JPG; we’ll store a URL only.</p>
          <div id="logo-status" class="text-xs text-gray-600 mt-1"></div>
        </div>
      </div>

      <hr class="border-gray-200">

      <!-- 3) AI -->
      <div>
        <h2 class="text-lg font-bold text-gray-900">3) AI Assistant</h2>
        <p class="text-sm text-gray-600">If enabled, we create your assistant using the OpenAI key you provide.</p>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-2">Enable AI chat?</label>
          <div class="flex gap-3">
            <label class="inline-flex items-center text-sm">
              <input type="radio" name="wants_ai_chat" value="true" class="mr-2" checked> Yes
            </label>
            <label class="inline-flex items-center text-sm">
              <input type="radio" name="wants_ai_chat" value="false" class="mr-2"> No
            </label>
          </div>
        </div>

        <div id="openai-wrap" class="mt-4">
          <div class="flex items-center justify-between gap-3">
            <label class="block text-xs font-semibold text-gray-600 mb-1">OpenAI API key *</label>
            <a href="https://platform.openai.com/signup" target="_blank"
               class="px-3 py-2 bg-gray-900 text-white text-xs font-bold rounded-full hover:opacity-90 transition">
              Create OpenAI Account
            </a>
          </div>
          <input type="password" name="openai_api_key"
                 class="w-full border rounded-lg p-2 text-sm bg-gray-50"
                 placeholder="••••••">
          <p class="text-xs text-gray-500 mt-2">
            We store keys securely. We never show your key back to you after saving.
          </p>
        </div>
      </div>

      <hr class="border-gray-200">

      <!-- 4) Calling -->
      <div>
        <h2 class="text-lg font-bold text-gray-900">4) Calling (Optional)</h2>
        <p class="text-sm text-gray-600">Enable inbound/outbound calling and SMS only if you want it.</p>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-1">Calling direction</label>
          <select name="calling_direction" id="calling-direction" class="w-full border rounded-lg p-2 text-sm bg-gray-50">
            <option value="none" selected>No calling</option>
            <option value="inbound">Inbound only</option>
            <option value="outbound">Outbound only</option>
            <option value="both">Inbound + Outbound</option>
          </select>
        </div>

        <div id="twilio-wrap" class="mt-4 hidden space-y-3">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-sm font-semibold text-gray-900">Twilio credentials</p>
              <p class="text-xs text-gray-500">Only required if you enable calling.</p>
            </div>
            <a href="https://www.twilio.com/try-twilio" target="_blank"
               class="px-3 py-2 bg-purple-600 text-white text-xs font-bold rounded-full hover:opacity-90 transition">
              Create Twilio Account
            </a>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Account SID</label>
            <input name="twilio_sid" class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="ACxxxxxxxx">
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Auth Token</label>
            <input type="password" name="twilio_token" class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="••••••">
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">From number (E.164)</label>
            <input name="twilio_from_number" class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="+17325079772">
          </div>

          <div class="pt-2">
            <label class="inline-flex items-center text-sm">
              <input type="checkbox" name="wants_sms" value="true" class="mr-2"> Enable SMS reminders
            </label>
          </div>

          <p class="text-xs text-gray-500">
            We store keys securely. We never show your Twilio token back to you after saving.
          </p>
        </div>
      </div>

      <hr class="border-gray-200">

      <!-- 5) Domain & Lead Forwarding -->
      <div>
        <h2 class="text-lg font-bold text-gray-900">5) Domain & Lead Forwarding</h2>
        <p class="text-sm text-gray-600">
          Submit your domain so we can configure DNS automatically. Leads will be forwarded to your business email.
        </p>

        <div class="grid sm:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Domain name *</label>
            <input name="domain_name" required class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="example.com">
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Lead forwarding email *</label>
            <input type="email" name="lead_forward_email" required class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="you@yourbusiness.com">
            <p class="text-xs text-gray-500 mt-2">
              We forward leads here. We do not access or manage your inbox.
            </p>
          </div>
        </div>

        <div class="grid sm:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-2">Do you already use Cloudflare?</label>
            <div class="flex gap-3">
              <label class="inline-flex items-center text-sm">
                <input type="radio" name="uses_cloudflare" value="true" class="mr-2"> Yes
              </label>
              <label class="inline-flex items-center text-sm">
                <input type="radio" name="uses_cloudflare" value="false" class="mr-2" checked> No
              </label>
            </div>
            <div id="cloudflare-email-wrap" class="mt-3 hidden">
              <label class="block text-xs font-semibold text-gray-600 mb-1">Cloudflare email (optional)</label>
              <input type="email" name="cloudflare_email" class="w-full border rounded-lg p-2 text-sm bg-gray-50"
                     placeholder="cloudflare-account@email.com">
            </div>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-2">Nameservers updated?</label>
            <label class="inline-flex items-center text-sm">
              <input type="checkbox" name="nameservers_updated" value="true" class="mr-2">
              I updated my domain registrar nameservers (if applicable)
            </label>
            <p class="text-xs text-gray-500 mt-2">
              DNS can take 24–48 hours to fully propagate after nameserver updates.
            </p>
          </div>
        </div>
      </div>

      <hr class="border-gray-200">

      <!-- 6) Payments -->
      <div>
        <h2 class="text-lg font-bold text-gray-900">6) Payments (Optional)</h2>
        <p class="text-sm text-gray-600">Enable Stripe only if you need payments or paid bookings.</p>

        <div class="mt-4">
          <label class="block text-xs font-semibold text-gray-600 mb-2">Do you want Stripe payments?</label>
          <div class="flex gap-3">
            <label class="inline-flex items-center text-sm">
              <input type="radio" name="wants_payments" value="true" class="mr-2" checked> Yes
            </label>
            <label class="inline-flex items-center text-sm">
              <input type="radio" name="wants_payments" value="false" class="mr-2"> No
            </label>
          </div>
        </div>

        <div id="stripe-wrap" class="mt-4 space-y-3">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-sm font-semibold text-gray-900">Stripe keys</p>
              <p class="text-xs text-gray-500">Only required if payments are enabled.</p>
            </div>
            <a href="https://dashboard.stripe.com/register" target="_blank"
               class="px-3 py-2 bg-purple-700 text-white text-xs font-bold rounded-full hover:opacity-90 transition">
              Create Stripe Account
            </a>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Publishable key (pk_)</label>
            <input name="stripe_publishable_key" class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="pk_live_...">
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Secret key (sk_)</label>
            <input type="password" name="stripe_secret_key" class="w-full border rounded-lg p-2 text-sm bg-gray-50" placeholder="••••••">
          </div>

          <p class="text-xs text-gray-500">
            We store keys securely. We never show your Stripe secret key back to you after saving.
          </p>
        </div>
      </div>

      <hr class="border-gray-200">

      <!-- Submit -->
      <div class="pt-2">
        <label class="flex items-start gap-2 text-sm">
          <input type="checkbox" id="confirm-check" class="mt-1" required>
          <span>
            I confirm the information above is correct. I understand this intake form is submitted once.
          </span>
        </label>

        <button id="submit-btn" type="submit"
          class="mt-4 w-full px-6 py-3 bg-blue-600 text-white text-sm font-extrabold rounded-xl hover:opacity-90 transition">
          Submit Onboarding →
        </button>

        <p id="form-status" class="text-sm mt-3 text-gray-600"></p>
      </div>

    </form>
  </section>

</div>

<script>
(function () {
  const colorsYes = document.querySelector('input[name="has_colors"][value="yes"]');
  const colorsNo  = document.querySelector('input[name="has_colors"][value="no"]');
  const colorsWrap = document.getElementById('colors-wrap');

  const aiYes = document.querySelector('input[name="wants_ai_chat"][value="true"]');
  const aiNo  = document.querySelector('input[name="wants_ai_chat"][value="false"]');
  const openaiWrap = document.getElementById('openai-wrap');
  const openaiKeyInput = document.querySelector('input[name="openai_api_key"]');

  const callingSelect = document.getElementById('calling-direction');
  const twilioWrap = document.getElementById('twilio-wrap');

  const cfYes = document.querySelector('input[name="uses_cloudflare"][value="true"]');
  const cfNo  = document.querySelector('input[name="uses_cloudflare"][value="false"]');
  const cfEmailWrap = document.getElementById('cloudflare-email-wrap');

  const payYes = document.querySelector('input[name="wants_payments"][value="true"]');
  const payNo  = document.querySelector('input[name="wants_payments"][value="false"]');
  const stripeWrap = document.getElementById('stripe-wrap');

  function toggle(el, show) {
    if (!el) return;
    el.classList.toggle('hidden', !show);
  }

  function syncColors() {
    toggle(colorsWrap, !!(colorsYes && colorsYes.checked));
  }

  function syncAI() {
    const enabled = !!(aiYes && aiYes.checked);
    toggle(openaiWrap, enabled);
    // If AI is disabled, clear and remove required-ness
    if (!enabled && openaiKeyInput) openaiKeyInput.value = '';
  }

  function syncCalling() {
    const val = callingSelect ? callingSelect.value : 'none';
    toggle(twilioWrap, val !== 'none');
    // If calling disabled, clear fields
    if (val === 'none') {
      ['twilio_sid','twilio_token','twilio_from_number'].forEach(n => {
        const input = document.querySelector(`[name="${n}"]`);
        if (input) input.value = '';
      });
      const sms = document.querySelector('input[name="wants_sms"]');
      if (sms) sms.checked = false;
    }
  }

  function syncCloudflare() {
    toggle(cfEmailWrap, !!(cfYes && cfYes.checked));
    if (cfNo && cfNo.checked) {
      const input = document.querySelector('input[name="cloudflare_email"]');
      if (input) input.value = '';
    }
  }

  function syncPayments() {
    const enabled = !!(payYes && payYes.checked);
    toggle(stripeWrap, enabled);
    if (!enabled) {
      ['stripe_publishable_key','stripe_secret_key'].forEach(n => {
        const input = document.querySelector(`[name="${n}"]`);
        if (input) input.value = '';
      });
    }
  }

  // Wire events
  if (colorsYes) colorsYes.addEventListener('change', syncColors);
  if (colorsNo) colorsNo.addEventListener('change', syncColors);

  if (aiYes) aiYes.addEventListener('change', syncAI);
  if (aiNo) aiNo.addEventListener('change', syncAI);

  if (callingSelect) callingSelect.addEventListener('change', syncCalling);

  if (cfYes) cfYes.addEventListener('change', syncCloudflare);
  if (cfNo) cfNo.addEventListener('change', syncCloudflare);

  if (payYes) payYes.addEventListener('change', syncPayments);
  if (payNo) payNo.addEventListener('change', syncPayments);

  // Initial state
  syncColors();
  syncAI();
  syncCalling();
  syncCloudflare();
  syncPayments();
})();

// Handle single-submit onboarding
(function () {
  const form = document.getElementById('onboarding-form');
  const statusEl = document.getElementById('form-status');
  const logoInput = document.getElementById('logo-file');
  const logoStatus = document.getElementById('logo-status');
  let uploadedLogoUrl = null;

  function getRadioBool(name) {
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? el.value === 'true' : false;
  }

  if (form) {
    if (logoInput) {
      logoInput.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        logoStatus.textContent = 'Uploading logo...';
        const formData = new FormData();
        formData.append('file', file);
        formData.append('path', `logos/${file.name}`);
        try {
          const resp = await fetch('/upload-file', { method: 'POST', body: formData });
          if (!resp.ok) throw new Error('Upload failed');
          const data = await resp.json().catch(() => ({}));
          if (data?.url_path) {
            uploadedLogoUrl = data.url_path;
            logoStatus.textContent = 'Logo uploaded.';
          } else {
            throw new Error('No URL returned');
          }
        } catch (err) {
          uploadedLogoUrl = null;
          logoStatus.textContent = 'Logo upload failed.';
          console.error(err);
        }
      });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = 'Submitting...';
      statusEl.classList.remove('text-red-600');

      const payload = {
        full_name: form.full_name.value,
        business_name: form.business_name.value,
        industry: form.industry.value,
        site_description: form.site_description.value,
        target_audience: form.target_audience.value || null,
        phone: form.phone.value || null,
        domain_name: form.domain_name.value,
        lead_forward_email: form.lead_forward_email.value,
        calling_direction: form['calling_direction'].value,
        wants_sms: form['wants_sms']?.checked || false,
        wants_payments: getRadioBool('wants_payments'),
        uses_cloudflare: getRadioBool('uses_cloudflare'),
        cloudflare_email: form.cloudflare_email?.value || null,
        twilio_sid: form.twilio_sid?.value || null,
        twilio_token: form.twilio_token?.value || null,
        twilio_from_number: form.twilio_from_number?.value || null,
        stripe_publishable_key: form.stripe_publishable_key?.value || null,
        stripe_secret_key: form.stripe_secret_key?.value || null,
        openai_api_key: form.openai_api_key?.value || null,
        has_logo: getRadioBool('has_logo'),
        brand_colors: form.brand_colors?.value || null,
        logo_url: uploadedLogoUrl,
      };

      try {
        const resp = await fetch('/dashboard/onboarding', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) {
          const data = await resp.json().catch(() => ({}));
          throw new Error(data.detail || 'Submission failed');
        }
        statusEl.textContent = 'Onboarding saved. We\'ll start provisioning shortly.';
      } catch (err) {
        statusEl.textContent = err.message || 'Unable to submit onboarding.';
        statusEl.classList.add('text-red-600');
      }
    });
  }
})();
</script>
{% endblock %}
