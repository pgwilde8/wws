{% extends "layout/base.html" %}
{% block header %}{% endblock %}
{% block footer %}{% endblock %}
{% block title %}Client Support Hub{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto p-4 sm:p-6 space-y-6">

  <!-- Header -->
  <header class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
    <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900">Support Center</h1>
    <p class="text-xs sm:text-sm text-gray-500 mt-1 uppercase tracking-wider">
      Help, updates, and conversations
    </p>
  </header>

  <!-- Plan Tier Resolver Banner -->
  {% if client.plan_tier %}
  <div class="bg-blue-50 border-l-4 border-blue-600 p-3 rounded-xl text-sm text-blue-800 font-semibold">
    Active Support Plan: <strong class="capitalize">{{ client.plan_tier.replace('_',' ') }}</strong>
  </div>
  {% endif %}

  <!-- Support Actions -->
  <section class="grid sm:grid-cols-1 md:grid-cols-2 gap-4 text-sm">

    <!-- Book Support Call -->
    <div class="bg-white p-4 rounded-2xl border shadow-sm">
      <h2 class="text-lg font-bold text-gray-900 mb-1">Book a Support Call</h2>
      <p class="text-xs text-gray-500 mb-3">Voice or video troubleshooting</p>
      <a href="/book-call" 
         class="inline-block px-5 py-2 bg-green-600 text-white text-sm font-bold rounded-full hover:opacity-90 transition">
         Book Call →
      </a>
    </div>

    <!-- Support Inbox -->
    <div class="bg-white p-4 rounded-2xl border shadow-sm">
      <h2 class="text-lg font-bold text-gray-900 mb-1">Support Inbox</h2>
      <p class="text-xs text-gray-500 mb-3">View your tickets</p>
      <a href="/dashboard/support/inbox" 
         class="inline-block px-5 py-2 bg-blue-100 text-blue-700 text-sm font-bold rounded-full hover:bg-blue-200 transition">
         View Inbox →
      </a>
    </div>

  </section>

  <!-- Create Ticket -->
  <section class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200 text-sm space-y-3">
    <h2 class="text-lg font-bold text-gray-900">Create a Support Ticket</h2>
    <p class="text-xs text-gray-500">Tell us what's needed; we'll respond by email.</p>
    <form id="support-ticket-form" class="space-y-3">
      <div>
        <label class="block text-xs font-semibold text-gray-700 mb-1">Subject</label>
        <input type="text" name="subject" required class="w-full border rounded-lg px-3 py-2 text-sm bg-gray-50" placeholder="Brief summary">
      </div>
      <div>
        <label class="block text-xs font-semibold text-gray-700 mb-1">Priority</label>
        <select name="priority" class="w-full border rounded-lg px-3 py-2 text-sm bg-gray-50">
          <option value="normal" selected>Normal</option>
          <option value="high">High</option>
          <option value="low">Low</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-semibold text-gray-700 mb-1">Message</label>
        <textarea name="message" required rows="4" class="w-full border rounded-lg px-3 py-2 text-sm bg-gray-50" placeholder="Describe the issue or request"></textarea>
      </div>
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded-full hover:opacity-90 transition">Submit Ticket</button>
      <div id="support-ticket-status" class="text-xs text-gray-500"></div>
    </form>
  </section>

  <!-- Responsibility Snapshot -->
  <section class="bg-white p-4 rounded-2xl border shadow-sm">
    <h2 class="text-lg font-bold text-gray-900 mb-2">What WebWise Handles For You</h2>
    <ul class="text-sm space-y-1 text-gray-700">
      <li>✔ Hosting & uptime</li>
      <li>✔ Automation maintenance</li>
      <li>✔ Security updates</li>
      <li>✔ Webhook reliability & monitoring</li>
      <li>✔ Support call scheduling</li>
      <li>✔ System optimization</li>
    </ul>
    <p class="text-xs text-gray-500 mt-3">You handle: product uploads, room/ranch rental listings, and content.</p>
  </section>

</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-4 right-4 z-50 hidden px-4 py-2 rounded-lg shadow bg-gray-900 text-white text-sm"></div>

<script>
async function fetchJson(url, options = {}) {
  const res = await fetch(url, { credentials: 'include', ...options });
  if (!res.ok) throw new Error(`${options.method || 'GET'} ${url} failed ${res.status}`);
  return res.json();
}

function showToast(message) {
  const toast = document.getElementById('toast');
  if (!toast) return;
  toast.textContent = message;
  toast.classList.remove('hidden');
  toast.style.opacity = '1';
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.classList.add('hidden'), 300);
  }, 2000);
}

function wireSupportForm() {
  const form = document.getElementById('support-ticket-form');
  if (!form) return;
  const statusEl = document.getElementById('support-ticket-status');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    const payload = {
      subject: fd.get('subject') || '',
      priority: fd.get('priority') || 'normal',
      message: fd.get('message') || '',
    };
    try {
      await fetchJson('/api/support/tickets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (statusEl) statusEl.textContent = 'Ticket submitted';
      showToast('Support ticket submitted');
      form.reset();
    } catch (err) {
      if (statusEl) statusEl.textContent = 'Submit failed';
      console.error('Ticket submit failed', err);
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
  wireSupportForm();
});
</script>
{% endblock %}
