{% extends "layout/base.html" %}
{% block title %}Admin – Project: {{ project.name }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto p-4 sm:p-6 space-y-6">

  <!-- Project Header -->
  <header class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
    <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900">{{ project.name }}</h1>
    <p class="text-xs sm:text-sm text-gray-500 capitalize mt-1">
      Status: {{ project.status.value | pretty_status }}
      {% if project.start_date %} • Started: {{ project.start_date.strftime('%b %d, %Y') }}{% endif %}
      {% if project.target_date %} • Target: {{ project.target_date.strftime('%b %d, %Y') }}{% endif %}
      {% if project.completed_date %} • Completed: {{ project.completed_date.strftime('%b %d, %Y') }}{% endif %}
    </p>
    <p class="text-sm text-gray-700 mt-2">{{ project.description or "No description provided." }}</p>
  </header>

  <!-- Budget & Plan -->
  <section class="grid sm:grid-cols-1 md:grid-cols-2 gap-4">
    <div class="bg-white p-4 rounded-xl shadow-sm border">
      <span class="text-xs text-gray-400 uppercase tracking-wide">Budget</span>
      <div class="text-lg font-bold text-gray-900">${{ project.total_budget or "—" }}</div>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-sm border">
      <span class="text-xs text-gray-400 uppercase tracking-wide">Plan Tier</span>
      <div class="text-sm font-semibold text-gray-900">{{ project.plan_tier or "Not assigned" }}</div>
    </div>
  </section>

  <!-- Integrations / Credentials Snapshot -->
  <section class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
    <h2 class="text-lg font-bold text-gray-900 mb-3">Integrations & Saved Credentials</h2>
    <div class="grid sm:grid-cols-1 md:grid-cols-3 gap-4 text-sm">

      <div class="p-3 border rounded-xl bg-gray-50">
        <div class="font-semibold flex justify-between">Stripe Connect <span>{% if creds.stripe_pk %}✔{% else %}—{% endif %}</span></div>
        <p class="text-xs text-gray-500 font-mono">pk: {{ creds.stripe_pk[:8] + "••••" if creds.stripe_pk else "—" }}</p>
      </div>

      <div class="p-3 border rounded-xl bg-gray-50">
        <div class="font-semibold flex justify-between">OpenAI <span>{% if creds.openai_key %}✔{% else %}—{% endif %}</span></div>
        <p class="text-xs text-gray-500 font-mono">key: {{ creds.openai_key[:8] + "••••••" if creds.openai_key else "—" }}</p>
      </div>

      <div class="p-3 border rounded-xl bg-gray-50">
        <div class="font-semibold flex justify-between">Twilio <span>{% if creds.twilio_sid %}✔{% else %}—{% endif %}</span></div>
        <p class="text-xs text-gray-600 font-mono">sid: {{ creds.twilio_sid[:8] + "••••" if creds.twilio_sid else "—" }}</p>
      </div>

    </div>
  </section>

  <!-- Milestones -->
  <section class="bg-white p-5 rounded-2xl shadow-sm border">
    <h2 class="text-lg font-bold text-gray-900 mb-3">Project Milestones</h2>
    <ul class="divide-y divide-dashed text-sm">
      {% for m in project.milestones %}
      <li class="py-2 flex justify-between items-center">
        <span class="text-gray-900 font-medium">{{ m.name }}</span>
        <span class="text-xs font-bold px-2 py-1 rounded-full
          {% if m.status == 'completed' %}bg-green-100 text-green-700
          {% elif m.status == 'in_progress' %}bg-blue-100 text-blue-700
          {% elif m.status == 'blocked' %}bg-red-100 text-red-700
          {% else %}bg-gray-100 text-gray-600{% endif %}">
          {{ m.status.replace('_',' ') }}
        </span>
      </li>
      {% endfor %}
      {% if not project.milestones %}
      <li class="py-2 text-gray-500 text-center">No milestones defined.</li>
      {% endif %}
    </ul>
  </section>

  <!-- Time Entries -->
  <section class="bg-white p-5 rounded-2xl border shadow-sm">
    <h2 class="text-lg font-bold text-gray-900 mb-3">Time Entries</h2>
    <div class="overflow-x-auto">
      <table class="w-full text-xs sm:text-sm bg-gray-50 border rounded-xl">
        <thead class="bg-white border-b">
          <tr>
            <th class="text-left p-2">Task</th>
            <th class="text-left p-2">Hours</th>
            <th class="text-left p-2">Date</th>
          </tr>
        </thead>
        <tbody>
          {% for t in project.time_entries %}
          <tr class="border-b last:border-none">
            <td class="p-2">{{ t.description or "—" }}</td>
            <td class="p-2">{{ t.hours or 0 }}</td>
            <td class="p-2 text-gray-500">{{ t.created_at.strftime('%b %d, %Y') if t.created_at else "—" }}</td>
          </tr>
          {% endfor %}
          {% if not project.time_entries %}
          <tr><td colspan="3" class="p-3 text-center text-gray-500">No time logged.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Recent Stripe Webhooks Related to This Project -->
  <section class="bg-white p-5 rounded-2xl border shadow-sm">
    <h2 class="text-lg font-bold text-gray-900 mb-3">Stripe Payment Events (from DB)</h2>
    <p class="text-xs text-gray-500 mb-2">Showing processed webhook events linked to this project, sourced from migrated legacy database.</p>

    <ul class="divide-y divide-dashed text-sm">
      {% for e in webhooks %}
      <li class="py-2">
        <div class="font-semibold text-gray-900">{{ e.event_type.replace('_',' ').replace('.',' ') }}</div>
        <span class="text-xs px-2 py-1 rounded-full font-bold
          {% if e.status=='success' %}bg-green-100 text-green-700
          {% elif e.status=='failed' %}bg-red-100 text-red-700
          {% else %}bg-blue-100 text-blue-700{% endif %}">
          {{ e.status }}
        </span>
        <span class="text-xs text-gray-500 ml-2">{{ e.received_at.strftime('%b %d, %H:%M') if e.received_at else "—" }}</span>
      </li>
      {% endfor %}
      {% if not webhooks %}
      <li class="py-2 text-gray-500 text-center">No recent Stripe events.</li>
      {% endif %}
    </ul>
  </section>

  <!-- Admin Actions -->
  <section class="bg-white p-5 rounded-2xl border shadow-sm">
    <h2 class="text-lg font-bold text-gray-900 mb-3">Admin Actions</h2>
    <div class="flex flex-wrap gap-3">
      <button disabled class="px-4 py-2 bg-gray-200 text-gray-500 rounded-xl text-sm font-semibold">Export .env (future)</button>
      <button disabled class="px-4 py-2 bg-red-100 text-red-600 rounded-xl text-sm font-semibold">Reset onboarding (future)</button>
      <button disabled class="px-4 py-2 bg-amber-100 text-amber-700 rounded-xl text-sm font-semibold">Mark reviewed (future)</button>
    </div>
  </section>

</div>
{% endblock %}
