{% extends "layout/base.html" %}
{% block title %}Client Detail | WebWise Solutions{% endblock %}
{% block header %}{% endblock %}
{% block footer %}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 sm:p-6 space-y-6">

  <!-- Client Identity Header -->
  <header class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-extrabold text-gray-900">
          {{ onboarding.business_name if onboarding else (client.name or 'Client') }}
        </h1>
        <p class="text-sm text-gray-600">Email: {{ client.email }}</p>
        <p class="text-xs text-gray-500 mt-1">Client ID: {{ client.id }}</p>
      </div>
      <div class="flex flex-col items-end gap-2">
        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-700">
          Created {{ client.created_at }}
        </span>
      </div>
    </div>
    {% if onboarding %}
    <div class="text-sm text-gray-600 mt-3 space-y-1">
      <p><strong>Owner:</strong> {{ onboarding.full_name }}</p>
      <p><strong>Industry:</strong> {{ onboarding.industry }}</p>
      {% if onboarding.phone %}<p><strong>Phone:</strong> {{ onboarding.phone }}</p>{% endif %}
      {% if onboarding.target_audience %}<p><strong>Audience:</strong> {{ onboarding.target_audience }}</p>{% endif %}
    </div>
    {% else %}
    <p class="text-sm text-amber-700 mt-3">No onboarding submission yet.</p>
    {% endif %}
  </header>

  <!-- Onboarding Snapshot -->
  <section class="bg-white p-4 rounded-2xl border shadow-sm">
    <h2 class="text-lg font-bold text-gray-900 mb-2">Onboarding Snapshot</h2>
    {% if onboarding %}
      <p class="text-sm text-gray-700 whitespace-pre-line">{{ onboarding.site_description }}</p>
    {% else %}
      <p class="text-sm text-gray-500">Awaiting onboarding form.</p>
    {% endif %}
  </section>

  <!-- Domain & Email -->
  <section class="grid sm:grid-cols-2 gap-4">
    <div class="bg-white p-4 rounded-2xl border shadow-sm">
      <h3 class="text-sm font-bold text-gray-900 mb-2">Domain</h3>
      {% if onboarding and onboarding.domain_name %}
        <p class="text-sm text-gray-800">{{ onboarding.domain_name }}</p>
      {% else %}
        <p class="text-sm text-gray-500">Not provided</p>
      {% endif %}
      <p class="text-xs text-gray-500 mt-1">
        Cloudflare: {{ 'Yes' if onboarding and onboarding.uses_cloudflare else 'No / Optional' }}
        {% if onboarding and onboarding.cloudflare_email %}
          • {{ onboarding.cloudflare_email }}
        {% endif %}
      </p>
    </div>
    <div class="bg-white p-4 rounded-2xl border shadow-sm">
      <h3 class="text-sm font-bold text-gray-900 mb-2">Lead Forwarding</h3>
      {% if onboarding and onboarding.lead_forward_email %}
        <p class="text-sm text-gray-800">{{ onboarding.lead_forward_email }}</p>
        <p class="text-xs text-gray-500 mt-1">We forward leads; inboxes are never accessed.</p>
      {% else %}
        <p class="text-sm text-gray-500">Not provided</p>
      {% endif %}
    </div>
  </section>

  <!-- Intent Badges -->
  <section class="bg-white p-4 rounded-2xl border shadow-sm">
    <h2 class="text-lg font-bold text-gray-900 mb-3">Integration Intents</h2>
    <div class="flex flex-wrap gap-2 text-xs">
      <span class="px-3 py-1 rounded-full {{ 'bg-green-100 text-green-800' if onboarding and onboarding.wants_payments else 'bg-gray-100 text-gray-700' }}">
        Stripe: {{ 'Enabled' if onboarding and onboarding.wants_payments else 'Optional' }}
      </span>
      <span class="px-3 py-1 rounded-full {{ 'bg-blue-100 text-blue-800' if onboarding and onboarding.calling_direction and onboarding.calling_direction != 'none' else 'bg-gray-100 text-gray-700' }}">
        Calling: {{ onboarding.calling_direction if onboarding else 'none' }}
      </span>
      <span class="px-3 py-1 rounded-full {{ 'bg-purple-100 text-purple-800' if onboarding and onboarding.wants_sms else 'bg-gray-100 text-gray-700' }}">
        SMS: {{ 'Enabled' if onboarding and onboarding.wants_sms else 'Optional' }}
      </span>
      <span class="px-3 py-1 rounded-full {{ 'bg-amber-100 text-amber-800' if onboarding and onboarding.uses_cloudflare else 'bg-gray-100 text-gray-700' }}">
        Cloudflare: {{ 'Enabled' if onboarding and onboarding.uses_cloudflare else 'Optional' }}
      </span>
    </div>
  </section>

  <!-- Provisioning Status -->
  <section class="bg-white p-4 rounded-2xl border shadow-sm">
    <h2 class="text-lg font-bold text-gray-900 mb-3">Provisioning</h2>
    <div class="divide-y divide-dashed text-sm text-gray-800">
      <div class="py-2 flex justify-between">
        <span>OpenAI Assistant</span>
        <span>
          {% if client.openai_assistant_id %}
            {{ client.openai_assistant_id[:6] }}••••{{ client.openai_assistant_id[-4:] }}
          {% else %}
            <span class="text-gray-500">Pending</span>
          {% endif %}
        </span>
      </div>
      <div class="py-2 flex justify-between">
        <span>Assistant Status</span>
        <span class="{{ 'text-green-600 font-semibold' if client.assistant_status=='created' else 'text-gray-500 capitalize' }}">{{ client.assistant_status or 'pending' }}</span>
      </div>
      <div class="py-2 flex justify-between">
        <span>Twilio Voice SID</span>
        <span>
          {% if client.twilio_voice_agent_sid %}
            {{ client.twilio_voice_agent_sid[:6] }}••••{{ client.twilio_voice_agent_sid[-4:] }}
          {% else %}
            <span class="text-gray-500">Not provisioned</span>
          {% endif %}
        </span>
      </div>
      <div class="py-2 flex justify-between">
        <span>Twilio Status</span>
        <span class="{{ 'text-green-600 font-semibold' if client.twilio_status=='provisioned' else 'text-gray-500 capitalize' }}">{{ client.twilio_status or 'optional' }}</span>
      </div>
    </div>
    <div class="mt-3 flex flex-wrap gap-3 items-center">
      <button id="prov-openai" class="px-4 py-2 bg-blue-600 text-white text-xs font-bold rounded-full hover:opacity-90 transition">Create OpenAI Assistant</button>
      <button id="prov-twilio" class="px-4 py-2 bg-purple-600 text-white text-xs font-bold rounded-full hover:opacity-90 transition">Provision Twilio Voice</button>
      <button id="reveal-prov" class="px-4 py-2 bg-gray-900 text-white text-xs font-bold rounded-full hover:opacity-90 transition">Reveal IDs</button>
      <span id="prov-status" class="text-xs text-gray-600"></span>
    </div>
    <div id="prov-full-wrap" class="mt-3 hidden text-sm text-gray-800 space-y-2">
      <div class="flex items-center justify-between gap-2">
        <div>
          <div class="text-xs text-gray-500">OpenAI Assistant ID</div>
          <code id="prov-openai-id" class="text-xs break-all"></code>
        </div>
        <button data-copy-target="prov-openai-id" class="copy-btn px-2 py-1 bg-gray-100 text-xs rounded border hover:bg-gray-200">Copy</button>
      </div>
      <div class="flex items-center justify-between gap-2">
        <div>
          <div class="text-xs text-gray-500">Twilio Voice SID</div>
          <code id="prov-twilio-id" class="text-xs break-all"></code>
        </div>
        <button data-copy-target="prov-twilio-id" class="copy-btn px-2 py-1 bg-gray-100 text-xs rounded border hover:bg-gray-200">Copy</button>
      </div>
    </div>
  </section>

  <!-- Logo -->
  <section class="bg-white p-4 rounded-2xl border shadow-sm">
    <h2 class="text-lg font-bold text-gray-900 mb-3">Logo</h2>
    {% if onboarding and onboarding.logo_url %}
      <div class="text-sm text-gray-800 flex items-center justify-between">
        <span>Uploaded logo</span>
        <a href="{{ onboarding.logo_url }}" target="_blank" class="px-3 py-1 bg-blue-600 text-white text-xs font-bold rounded-full hover:opacity-90 transition">View / Download</a>
      </div>
    {% else %}
      <p class="text-sm text-gray-500">No logo uploaded.</p>
    {% endif %}
  </section>

  <!-- Credentials (admin only, masked) -->
  <section class="bg-white p-4 rounded-2xl border shadow-sm">
    <h2 class="text-lg font-bold text-gray-900 mb-3">Credentials (masked)</h2>
    {% set cred = credentials %}
    {% macro mask(val) -%}
      {%- if not val -%}
        —
      {%- elif val|length <= 8 -%}
        ****
      {%- else -%}
        {{ val[:4] }}****{{ val[-4:] }}
      {%- endif -%}
    {%- endmacro %}
    <ul class="divide-y divide-dashed text-sm text-gray-800">
      <li class="py-2 flex justify-between"><span>Stripe Publishable</span><span>{{ mask(cred.stripe_publishable_key if cred else None) }}</span></li>
      <li class="py-2 flex justify-between"><span>Stripe Secret</span><span>{{ mask(cred.stripe_secret_key if cred else None) }}</span></li>
      <li class="py-2 flex justify-between"><span>OpenAI API Key</span><span>{{ mask(cred.openai_api_key if cred else None) }}</span></li>
      <li class="py-2 flex justify-between"><span>Twilio SID</span><span>{{ mask(cred.twilio_sid if cred else None) }}</span></li>
      <li class="py-2 flex justify-between"><span>Twilio Token</span><span>{{ mask(cred.twilio_token if cred else None) }}</span></li>
      <li class="py-2 flex justify-between"><span>Twilio From</span><span>{{ cred.twilio_from_number if cred and cred.twilio_from_number else '—' }}</span></li>
      <li class="py-2 flex justify-between"><span>DNS API Key</span><span>{{ mask(cred.dns_api_key if cred else None) }}</span></li>
    </ul>
    <div class="mt-3 flex flex-wrap gap-2 text-xs">
      <button id="reveal-creds" class="px-3 py-1 bg-gray-900 text-white rounded-full font-semibold hover:opacity-90 transition">Reveal full values</button>
      <span id="reveal-status" class="text-gray-500"></span>
    </div>
    <div id="creds-full" class="mt-3 hidden text-sm text-gray-800 space-y-1">
      <div class="flex justify-between"><span>Stripe Publishable</span><code id="full-spk" class="break-all text-xs"></code></div>
      <div class="flex justify-between"><span>Stripe Secret</span><code id="full-ssk" class="break-all text-xs"></code></div>
      <div class="flex justify-between"><span>OpenAI API Key</span><code id="full-oak" class="break-all text-xs"></code></div>
      <div class="flex justify-between"><span>Twilio SID</span><code id="full-tsid" class="break-all text-xs"></code></div>
      <div class="flex justify-between"><span>Twilio Token</span><code id="full-ttok" class="break-all text-xs"></code></div>
      <div class="flex justify-between"><span>Twilio From</span><code id="full-tfrom" class="break-all text-xs"></code></div>
      <div class="flex justify-between"><span>DNS API Key</span><code id="full-dns" class="break-all text-xs"></code></div>
    </div>
  </section>

</div>

<script>
(function() {
  const btn = document.getElementById('reveal-creds');
  const statusEl = document.getElementById('reveal-status');
  const fullWrap = document.getElementById('creds-full');
  if (!btn) return;
  btn.addEventListener('click', async () => {
    statusEl.textContent = 'Loading...';
    try {
      const resp = await fetch('/admin/clients/{{ client.id }}/credentials/raw', { credentials: 'include' });
      if (!resp.ok) throw new Error('Failed to load credentials');
      const data = await resp.json();
      const c = data.credentials || {};
      const setText = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val || '—';
      };
      setText('full-spk', c.stripe_publishable_key);
      setText('full-ssk', c.stripe_secret_key);
      setText('full-oak', c.openai_api_key);
      setText('full-tsid', c.twilio_sid);
      setText('full-ttok', c.twilio_token);
      setText('full-tfrom', c.twilio_from_number);
      setText('full-dns', c.dns_api_key);
      fullWrap.classList.remove('hidden');
      statusEl.textContent = 'Loaded.';
    } catch (err) {
      statusEl.textContent = 'Unable to reveal credentials.';
      console.error(err);
    }
  });
})();

(function() {
  const provStatus = document.getElementById('prov-status');
  const call = async (url) => {
    provStatus.textContent = 'Working...';
    try {
      const resp = await fetch(url, { method: 'POST', credentials: 'include' });
      if (!resp.ok) throw new Error('Failed');
      provStatus.textContent = 'Triggered. Refresh to see status.';
    } catch (e) {
      provStatus.textContent = 'Provisioning failed.';
      console.error(e);
    }
  };
  const btnO = document.getElementById('prov-openai');
  const btnT = document.getElementById('prov-twilio');
  if (btnO) btnO.addEventListener('click', () => call('/admin/clients/{{ client.id }}/provision/openai'));
  if (btnT) btnT.addEventListener('click', () => call('/admin/clients/{{ client.id }}/provision/twilio'));
  const btnR = document.getElementById('reveal-prov');
  const fullWrap = document.getElementById('prov-full-wrap');
  if (btnR) btnR.addEventListener('click', async () => {
    provStatus.textContent = 'Loading IDs...';
    try {
      const resp = await fetch('/admin/clients/{{ client.id }}/provision/raw', { credentials: 'include' });
      if (!resp.ok) throw new Error('Failed');
      const data = await resp.json();
      const p = data.provisioning || {};
      const setText = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val || '—';
      };
      setText('prov-openai-id', p.openai_assistant_id);
      setText('prov-twilio-id', p.twilio_voice_agent_sid);
      if (fullWrap) fullWrap.classList.remove('hidden');
      provStatus.textContent = 'IDs ready to copy.';
    } catch (e) {
      provStatus.textContent = 'Unable to reveal IDs.';
      console.error(e);
    }
  });

  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const targetId = btn.getAttribute('data-copy-target');
      const el = document.getElementById(targetId);
      if (!el || !el.textContent) return;
      try {
        await navigator.clipboard.writeText(el.textContent);
        provStatus.textContent = 'Copied.';
      } catch (err) {
        provStatus.textContent = 'Copy failed.';
        console.error(err);
      }
    });
  });
})();
</script>
{% endblock %}
